<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Auth Demo ‚Äî Registro, Login y Reset</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #9ca3af;
            --border: #1f2937;
            --ok: #10b981;
            --err: #ef4444;
            --btn: #4f46e5;
            --text: #e5e7eb;
            --accent: #22d3ee;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            background: linear-gradient(160deg, #0b1022, #111827 60%, #000);
            color: var(--text);
            font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .contenedor {
            width: 100%;
            max-width: 980px;
            display: grid;
            gap: 16px;
            grid-template-columns: 1.1fr 0.9fr;
        }
        .col {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            backdrop-filter: blur(6px);
        }
        h2 {
            margin: 0 0 12px;
            font-size: 18px;
        }
        .fila {
            display: flex;
            gap: 10px;
        }
        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }
        input,
        button,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0b1220;
            color: var(--text);
            outline: none;
        }
        input:focus,
        textarea:focus {
            border-color: #334155;
        }
        button {
            cursor: pointer;
            background: var(--btn);
            border: none;
            font-weight: 700;
        }
        button.sec {
            background: #374151;
        }
        .sep {
            height: 10px;
        }
        .estado {
            font-size: 12px;
            color: var(--muted);
            white-space: pre-wrap;
        }
        .ok {
            color: var(--ok);
        }
        .err {
            color: var(--err);
        }
        .token {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
            "Liberation Mono", monospace;
            font-size: 12px;
            background: #0b1020;
            border: 1px dashed #334155;
            padding: 10px;
            border-radius: 8px;
            word-break: break-all;
        }
        .tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #0b1220;
            border: 1px solid #263042;
            color: #a6b6d9;
        }
        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .pie {
            margin-top: 10px;
            font-size: 11px;
            color: #8aa;
            text-align: center;
        }
        .base-url {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        .base-url input {
            flex: 1;
        }
        .auth-info {
            display: grid;
            gap: 8px;
        }
        .subtle {
            color: #9fb2d4;
            font-size: 12px;
        }
        hr {
            border: none;
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }
        @media (max-width: 900px) {
            .contenedor {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="contenedor">
    <!-- Columna Izquierda: Registro y Login -->
    <section class="col">
        <div class="base-url">
            <span class="tag">BASE_URL</span>
            <input id="baseUrl" placeholder="http://localhost:8080" />
            <button id="guardarBase" class="sec">Usar</button>
        </div>

        <h2>Registro</h2>
        <div class="grid2">
            <div>
                <label>Nombres</label>
                <input id="regNombres" placeholder="Juan" />
            </div>
            <div>
                <label>Apellidos</label>
                <input id="regApellidos" placeholder="P√©rez" />
            </div>
            <div>
                <label>Usuario</label>
                <input id="regUsername" placeholder="juanp" />
            </div>
            <div>
                <label>Tel√©fono (opcional)</label>
                <input id="regTelefono" placeholder="+51 900 000 000" />
            </div>
            <div>
                <label>Email</label>
                <input id="regEmail" placeholder="correo@demo.com" />
            </div>
            <div>
                <label>Contrase√±a</label>
                <input id="regPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
        </div>
        <div class="sep"></div>
        <button id="btnRegistrar">Crear cuenta</button>
        <div id="estadoRegistro" class="estado"></div>

        <hr />

        <h2>Login</h2>
        <div class="grid2">
            <div>
                <label>Email</label>
                <input id="loginEmail" placeholder="correo@demo.com" />
            </div>
            <div>
                <label>Contrase√±a</label>
                <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
        </div>
        <div class="sep"></div>
        <div class="fila">
            <button id="btnLogin">Ingresar</button>
            <button id="btnLogout" class="sec">Salir</button>
        </div>
        <div id="estadoLogin" class="estado"></div>

        <div class="sep"></div>
        <div class="auth-info">
            <div>
                <span class="tag">Usuario</span>
                <span id="usuarioActual" class="subtle">‚Äî</span>
            </div>
            <div><span class="tag">JWT</span></div>
            <div id="tokenBox" class="token">‚Äî</div>
        </div>

        <div class="pie">
            Tip: El token se guarda en <code>localStorage</code> como
            <b>authToken</b>.
        </div>
    </section>

    <!-- Columna Derecha: Reset Password -->
    <section class="col">
        <h2>Olvid√© mi contrase√±a</h2>
        <div>
            <label>Email</label>
            <input id="olvidoEmail" placeholder="correo@demo.com" />
        </div>
        <div class="sep"></div>
        <button id="btnOlvido">Enviar enlace</button>
        <div id="estadoOlvido" class="estado"></div>

        <hr />

        <h2>Resetear contrase√±a</h2>
        <p class="subtle">
            Pega aqu√≠ el <b>token</b> que te lleg√≥ al correo (par√°metro
            <code>token</code> del enlace).
        </p>
        <div>
            <label>Token</label>
            <input
                    id="resetToken"
                    placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (o aleatorio base64-url)"
            />
        </div>
        <div class="grid2">
            <div>
                <label>Nueva contrase√±a</label>
                <input
                        id="resetPassword"
                        type="password"
                        placeholder="NuevoPass#2025"
                />
            </div>
            <div>
                <label>Confirmar contrase√±a</label>
                <input
                        id="resetPassword2"
                        type="password"
                        placeholder="NuevoPass#2025"
                />
            </div>
        </div>
        <div class="sep"></div>
        <button id="btnReset">Cambiar contrase√±a</button>
        <div id="estadoReset" class="estado"></div>

        <hr />

        <h2>Ping autenticado (opcional)</h2>
        <p class="subtle">
            Prueba un endpoint protegido para verificar que el JWT funciona.
        </p>
        <div class="fila">
            <input id="rutaProtegida" placeholder="/api/yo" />
            <button id="btnPing" class="sec">GET</button>
        </div>
        <div class="sep"></div>
        <div id="estadoPing" class="estado"></div>
    </section>
</div>

<script>
    // ====== Config ======
    const BASE_URL_INPUT = document.getElementById("baseUrl");
    const DEFAULT_BASE =
        localStorage.getItem("BASE_URL") || "http://localhost:8080";
    BASE_URL_INPUT.value = DEFAULT_BASE;

    function base() {
        return localStorage.getItem("BASE_URL") || "http://localhost:8080";
    }
    function setBase(url) {
        localStorage.setItem("BASE_URL", url);
    }

    document.getElementById("guardarBase").addEventListener("click", () => {
        const v = BASE_URL_INPUT.value.trim();
        if (!v) {
            alert("Ingresa una BASE_URL");
            return;
        }
        setBase(v);
        alert("BASE_URL guardada: " + v);
    });

    // ====== Helpers ======
    const tokenBox = document.getElementById("tokenBox");
    const usuarioActual = document.getElementById("usuarioActual");

    function setToken(jwt, email) {
        if (jwt) {
            localStorage.setItem("authToken", jwt);
            tokenBox.textContent = jwt;
        } else {
            localStorage.removeItem("authToken");
            tokenBox.textContent = "‚Äî";
        }
        usuarioActual.textContent = email || "‚Äî";
    }

    function authHeaders(extra = {}) {
        const t = localStorage.getItem("authToken");
        return {
            "Content-Type": "application/json",
            ...(t ? { Authorization: "Bearer " + t } : {}),
            ...extra,
        };
    }

    async function postJson(url, body, withAuth = false) {
        const res = await fetch(url, {
            method: "POST",
            headers: withAuth
                ? authHeaders()
                : { "Content-Type": "application/json" },
            body: JSON.stringify(body),
        });
        let data = null;
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
            data = await res.json().catch(() => null);
        } else {
            data = await res.text().catch(() => null);
        }
        return { ok: res.ok, status: res.status, data };
    }

    // ====== Estado inicial ======
    setToken(localStorage.getItem("authToken") || "", "");

    // ====== Registro ======
    const estadoRegistro = document.getElementById("estadoRegistro");
    document
        .getElementById("btnRegistrar")
        .addEventListener("click", async () => {
            estadoRegistro.textContent = "Creando cuenta...";

            const payload = {
                firstName: document.getElementById("regNombres").value.trim(),
                lastName: document.getElementById("regApellidos").value.trim(),
                username: document.getElementById("regUsername").value.trim(),
                email: document.getElementById("regEmail").value.trim(),
                password: document.getElementById("regPassword").value,
                phoneNumber:
                    document.getElementById("regTelefono").value.trim() || null,
            };

            // Ajusta si tu RegisterRequestDto tiene menos/m√°s campos.
            const { ok, status, data } = await postJson(
                base() + "/auth/register",
                payload,
                false
            );
            if (ok) {
                estadoRegistro.innerHTML = `<span class="ok">‚úÖ Registrado</span>`;
            } else {
                estadoRegistro.innerHTML = `<span class="err">‚ùå Error ${status}</span>\n${
                    typeof data === "string" ? data : JSON.stringify(data)
                }`;
            }
        });

    // ====== Login ======
    const estadoLogin = document.getElementById("estadoLogin");
    document
        .getElementById("btnLogin")
        .addEventListener("click", async () => {
            estadoLogin.textContent = "Ingresando...";
            const payload = {
                email: document.getElementById("loginEmail").value.trim(),
                password: document.getElementById("loginPassword").value,
            };
            const { ok, status, data } = await postJson(
                base() + "/auth/login",
                payload,
                false
            );
            // Se espera que AuthResponseDto tenga al menos { token, email|username }
            if (ok) {
                const jwt =
                    (data && (data.token || data.jwt || data.accessToken)) || "";
                const email =
                    (data && (data.email || data.username)) || payload.email;
                setToken(jwt, email);
                estadoLogin.innerHTML = `<span class="ok">‚úÖ Login OK</span>`;
            } else {
                setToken("", "");
                estadoLogin.innerHTML = `<span class="err">‚ùå Error ${status}</span>\n${
                    typeof data === "string" ? data : JSON.stringify(data)
                }`;
            }
        });

    document.getElementById("btnLogout").addEventListener("click", () => {
        setToken("", "");
        alert("Sesi√≥n cerrada localmente.");
    });

    // ====== Olvid√© mi contrase√±a ======
    const estadoOlvido = document.getElementById("estadoOlvido");
    document
        .getElementById("btnOlvido")
        .addEventListener("click", async () => {
            estadoOlvido.textContent = "Enviando correo...";
            const email = document.getElementById("olvidoEmail").value.trim();

            const { ok, status, data } = await postJson(
                base() + "/auth/forget-password",
                { email },
                false
            );
            if (ok) {
                estadoOlvido.innerHTML = `<span class="ok">üì® Si existe la cuenta, recibir√°s un correo con instrucciones.</span>`;
            } else {
                estadoOlvido.innerHTML = `<span class="err">‚ùå Error ${status}</span>\n${
                    typeof data === "string" ? data : JSON.stringify(data)
                }`;
            }
        });

    // ====== Reset password ======
    const estadoReset = document.getElementById("estadoReset");
    document
        .getElementById("btnReset")
        .addEventListener("click", async () => {
            estadoReset.textContent = "Procesando...";
            const token = document.getElementById("resetToken").value.trim();
            const p1 = document.getElementById("resetPassword").value;
            const p2 = document.getElementById("resetPassword2").value;

            if (!token) {
                estadoReset.innerHTML = `<span class="err">Token requerido</span>`;
                return;
            }
            if (!p1 || p1 !== p2) {
                estadoReset.innerHTML = `<span class="err">Las contrase√±as no coinciden</span>`;
                return;
            }

            const payload = { token, nuevaPassword: p1 };
            console.log(payload);
            const { ok, status, data } = await postJson(
                base() + "/auth/reset-password",
                payload,
                false
            );

            if (ok || status === 204) {
                estadoReset.innerHTML = `<span class="ok">‚úÖ Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.</span>`;
            } else {
                estadoReset.innerHTML = `<span class="err">‚ùå Error ${status}</span>\n${
                    typeof data === "string" ? data : JSON.stringify(data)
                }`;
            }
        });

    // ====== Ping protegido ======
    const estadoPing = document.getElementById("estadoPing");
    document.getElementById("btnPing").addEventListener("click", async () => {
        estadoPing.textContent = "Llamando...";
        const ruta =
            document.getElementById("rutaProtegida").value.trim() || "/api/yo";
        const res = await fetch(base() + ruta, { headers: authHeaders() });
        const ct = res.headers.get("content-type") || "";
        let data = null;
        if (ct.includes("application/json"))
            data = await res.json().catch(() => null);
        else data = await res.text().catch(() => null);
        estadoPing.innerHTML = res.ok
            ? `<span class="ok">‚úÖ ${res.status}</span>\n${
                typeof data === "string" ? data : JSON.stringify(data, null, 2)
            }`
            : `<span class="err">‚ùå ${res.status}</span>\n${
                typeof data === "string" ? data : JSON.stringify(data, null, 2)
            }`;
    });
</script>
</body>
</html>
